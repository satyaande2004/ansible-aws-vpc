---
- name: Setup Vprofile stack
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: import VPC setup variable
      include_vars: vars/output_vars
    - name: import vprofile setup variable
      include_vars: vars/vprostacksetup
    - name: Create vprofile ec2 key
      ec2_key:
                name: vprokey
                region: "{{region}}"
      register: vprokey_out

    - name: Save private key into file bastion-key.pem
      copy:
                content: "{{vprokey_out.key.private_key}}"
                dest: "./loginkeypro.pem"
                mode: 0600
      when: vprokey_out.changed
    - name: Create Securiry Group for Load Balancer
      ec2_group:
          name: vproELB-sg
          description: Allow port 80 from everywhere and all port within sg
          region: "{{region}}"
          vpc_id: "{{vpcid}}"
          rules:
            - proto: tcp
              from_port: 80
              to_port: 80
              cidr_ip: 0.0.0.0/0
      register: vproELBSG_out

    - name: crate security group for vprofilestack
      ec2_group:
             name: vproStack-sg
             description: allow all on port 22
             vpc_id: "{{vpcid}}"
             region: "{{region}}"
             purge_rules: no
             rules:
               - proto: tcp
                 from_port: 80
                 to_port: 80
                 group_id: "{{vproELBSG_out.group_id}}"
               - proto: tcp
                 from_port: 22
                 to_port: 22
                 group_id: "{{BastionSGid}}"
      register: vproStack-sg_out

    - name: crate security group with ownSG id
      ec2_group:
                  name: vproStack-sg
                  description: allow all on port 22
                  vpc_id: "{{vpcid}}"
                  region: "{{region}}"
                  purge_rules: no
                  rules:
                    - proto: all
                      group_id: "{{vproStack-sg_out.group_id}}}"



