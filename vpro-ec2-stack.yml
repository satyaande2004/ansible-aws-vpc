---
- name: Setup Vprofile stack
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: import VPC setup variable
      include_vars: vars/output_vars
    - name: import vprofile setup variable
      include_vars: vars/vprostacksetup
    - name: Create vprofile ec2 key
      ec2_key:
                name: vprokey
                region: "{{region}}"
      register: vprokey_out

    - name: Save private key into file bastion-key.pem
      copy:
                content: "{{vprokey_out.key.private_key}}"
                dest: "./loginkeypro.pem"
                mode: 0600
      when: vprokey_out.changed
    - name: Create Securiry Group for Load Balancer
      ec2_group:
          name: vproELB-sg
          description: Allow port 80 from everywhere and all port within sg
          region: "{{region}}"
          vpc_id: "{{vpcid}}"
          rules:
            - proto: tcp
              from_port: 80
              to_port: 80
              cidr_ip: 0.0.0.0/0
      register: vproELBSG_out

    - name: Create Securiry Group for Vprofile Stack
      ec2_group:
           name: vproStack-sg
           description: Allow port 22 from everywhere and all port within sg
           region: "{{region}}"
           vpc_id: "{{vpcid}}"
           purge_rules: no
           rules:
             - proto: tcp
               from_port: 80
               to_port: 80
               group_id: "{{vproELBSG_out.group_id}}"

             - proto: tcp
               from_port: 22
               to_port: 22
               group_id: "{{BastionSGid}}"
      register: vproStackSG_out

    - name: Update Securiry Group with its own sg id
      ec2_group:
           name: vproStack-sg
           description: Allow port 22 from everywhere and all port within sg
           region: "{{region}}"
           vpc_id: "{{vpcid}}"
           purge_rules: no
           rules:
             - proto: all
               group_id: "{{vproStackSG_out.group_id}}"
    - name: Creating Nginx web01
      ec2:
         key_name: vprokey
         region: "{{region}}"
         instance_type: t2.micro
         image: "{{nginx_ami}}"
         vpc_id: "{{vpcid}}"
         vpc_subnet_id: "{{privsub1id}}"
         wait: yes
         wait_time: 300
         instance_tags:
            Name: "web01"
            project: "vprofile"
            owner: satya
         exec_count: 1
         count_tag:
             Name: "web01"
             project: "vprofile"
             owner: satya
         group_id: "{{vproStackSG_out.group_id}}"
      register: web01_out



